---
layout: post
title: "보안"
subtitle: "쿠키, 세션, JWT."
date: 2021-01-27 20:25:00 +0900
background: '/img/posts/01.jpg'
categories: ['BackEnd']
---
# 쿠키
쿠키는 클라이언트 로컬에 저장되는 키와 값이 들어있는 작은 데이터 파일이다. 쿠키에는 이름, 값, 만료날짜(쿠키 저장기간), 경로 정보가 들어있다. 쿠키는 일정시간동안 데이터를 저장할 수 있다(로그인 상태 유지에 활용).쿠키는 클라이언트의 상태 정보를 로컬에 저장했다가 참조한다.


![image](https://user-images.githubusercontent.com/46861704/105983259-ce4a1d00-60db-11eb-878c-f3f96a7d9983.png)

- 쿠키 프로세스
  1. 브라우저에서 웹페이지 접속
  2. 클라이언트가 요청한 웹페이지를 받으면서 쿠키를 클라이언트 로컬(하드)에 저장
  3. 클라이언트가 재 요청시 웹페이지 요청과 함께 쿠키값도 전송
  4. 지속적으로 로그인 정보를 가지고 있는 것처럼 사용

- 쿠키의 제한
  - 클라이언트에 300개까지 쿠키저장 가능, 하나의 도메인당 20개의 값만 가질 수 있음, 하나의 쿠키값은 4KB까지저장
  - Response Header에 Set-Cookie 속성을 사용하면 클라이언트에 쿠키를 만들 수 있다.
  - 쿠키는 사용자가 따로 요청하지 않아도 브라우저가 Request시에 Request Header를 넣어서 자동으로 서버에 전송한다.

# 세션
일정 시간동안 같은 브라우저로 부터 들어오는 일련의 요구를 하나의 상태로 보고 그 상태를 유지하는 기술. 즉,
웹 브라우저를 통해 웹 서버에 접속한 이후로 브라우저를 종료할 때 까지 유지되는 상태이다. 클라이언트가
Request를 보내면, 해당 서버의 엔진이 클라이언트에게 유일한 ID를 부여하는데 이것이 세션ID다.

- 세션 프로세스
  1. 클라이언트가 서버에 접속시 세션 ID를 발급
  2. 서버에서는 클라이언트로 발급해준 세션 ID를 쿠키를 사용해 저장 (JSESSIONID)
  3. 클라이언트는 다시 접속할 때, 이 쿠키(JSESSIONID)를 이용해서 세션ID값을 서버에 전달
  4. 
즉, 세션을 구별하기 위해 ID가 필요하고 그 ID만 쿠키를 이용해서 저장해놓는다. (쿠키사용) 쿠키는 자동으로
서버에 전송되니까 서버에서 세션아이디에 따른 처리를 할 수 있다.

# 쿠키와 세션의 차이

| | 쿠키|세션|
|-|-|-|
|저장위치|클라이언트에 파일로 저장|서버에 저장|
|보안| 클라이언트 로컬에 저장, request에서 공격당할 위험이 있기 때문에 보안에 취약|쿠키를 이용해서 session id만 저장하고 그것으로 구분해서 서버에서 처리하기 때문에 비교적 보안성이 좋다|
|유지기간|만료시간이 있지만 파일로 저장되기 때문에 브라우저를 종료해도 계속해서 정보가 남는다|만료시간을 정할 수 있지만 브라우저가 종료되면 만료시간에 상관없이 삭제|
|속도|쿠키에 정보가 있기 때문에 서버에 요청 시 속도가 빠르다| 정보가 서버에 있기 때문에 처리가 요구되어 비교적 느리다|

- 세션 대신 쿠키를 사용하는 이유 
  - 세션은 서버의 자원을 사용하기 때문에 무분별하게 만들다보면 서버의 메모리가 감당할 수 없어질 수가 있고 속도가 느려질 수 있기 때문에.

# JWT
JWT(Json Web Token)란 Json 포맷을 이용하여 사용자에 대한 속성을 저장하는 Claim 기반의 Web Token이다. JWT는 토큰 자체를 정보로 사용하는 Self-Contained 방식으로 정보를 안전하게 전달한다. 주로 회원 인증이나 정보 전달에 사용되는 JWT는 아래의 로직을 따라서 처리된다.

![JWT로직](https://blog.kakaocdn.net/dn/rdboS/btqArUrgcMr/HWY80zNL9reAv6FeE6AYE1/img.png)

쿠키는 보안이 취약하고, 세션은 서버에 별도 세션 저장소를 유지해 서버의 부하가 커질 위험들이 존재한다. JWT를 사용하면 별도의 저장소가 필요하지도 않고, 토큰 발급 후 클라이언트에 전송, 추후 요청에 대해 검증하는 과정만 있으면 된다.

## JWT 구조
- 총 3가지 문자열로 구성되어 있다.
![image](https://user-images.githubusercontent.com/46861704/105985879-76151a00-60df-11eb-8d63-93ac9941b978.png)
    1. 헤더
        - typ과 alg 두 가지 정보로 구성
          - typ : 토큰의 타입을 지정
          - alg : 알고리즘 방식을 지정하며(Signature를 해싱하기 위한 알고리즘), 서명(Signature) 및 토큰 검증에 사용(HS256(SHA256) 또는 RSA) 
        ~~~json
        {
            "alg" : "HS256",
            "typ" : JWT
        }
        ~~~
    2. 정보(payload)
       - 토큰에서 사용할 정보의 조각들인 클레임(Claim)이 담겨 있다. 클레임은 총 3가지로 나누어지며, Json(Key/Value) 형태로 다수의 정보를 넣을 수 있다.
       - 등록된 클레임(Registered Claim)
         - 토큰 정보를 표현하기 위해 이미 정해진 종류의 데이터
         - 선택적으로 작성이 가능하며 사용할 것을 권장
         - key는 길이 3의 String(간결하게 하기 위해)
           - iss: 토큰 발급자(issuer)
           - sub: 토큰 제목(subject)
           - aud: 토큰 대상자(audience)
           - exp: 토큰 만료 시간(expiration), NumericDate 형식으로 되어 있어야 함 ex) 1480849147370
           - nbf: 토큰 활성 날짜(not before), 이 날이 지나기 전의 토큰은 활성화되지 않음
           - iat: 토큰 발급 시간(issued at), 토큰 발급 이후의 경과 시간을 알 수 있음
           - jti: JWT 토큰 식별자(JWT ID), 중복 방지를 위해 사용하며, 일회용 토큰(Access Token) 등에 사용

 
       - 공개 클레임(Public Claim)
         - 사용자 정의 클레임으로, 공개용 정보를 위해 사용.
         - 충돌 방지를 위해 URI 포맷을 사용한다.   
            ~~~json
            { "https://mangkyu.tistory.com": true }
            ~~~
       - 비공개 클레임(Private Claim)
         - 사용자 정의 클레임으로, 서버와 클라이언트 사이에 임의로 지정한 정보를 저장
            ~~~json
            { "token_type": access }
            ~~~
    3. 서명(signature)
       - 토큰을 인코딩하거나 유효성 검증을 할 때 사용하는 고유한 암호화 코드

서명(Signature)은 위에서 만든 헤더(Header)와 페이로드(Payload)의 값을 각각 BASE64로 인코딩하고, 인코딩한 값을 비밀 키를 이용해 헤더(Header)에서 정의한 알고리즘으로 해싱을 하고, 이 값을 다시 BASE64로 인코딩하여 생성한다.

생성된 토큰은 HTTP 통신 시 Authorization이라는 key의 value로 사용된다. 일반적으로 value에는 Bearer이 앞에 붙여진다.
~~~json
{ 
 "Authorization": "Bearer {생성된 토큰 값}",
}
~~~

## JWT 장단점
- 장점
  - 사용자 인증에 필요한 정보는 토큰 자체에 의존하기에 별도의 인증 저장소가 필요 없다.
  - URL 파라미터와 헤더에 사용 가능하다(url-safe)
  - 디버깅 및 관리가 용이하다
  - 트래픽에 대한 부담이 낮다
  - 독립적이며, REST 서비스로 제공 가능하다
  - 내장된 만료 기능을 제공한다
- 단점
  - 서버에서 사용자 정보를 조작하더라도 이미 발급된 토큰에 대해서는 직접 적용이 불가능하다.
  - 사용자 정보 데이터가 커질수록 토큰 크기도 커진다.
  - 거의 모든 클라이언트의 요청에 토큰이 포함되므로 데이터 트래픽 크기가 커질 수 있다.
  - 토큰이 유출되면 발급된 사용자 대산 사용이 가능해진다.


# Reference
- > [[Server] JWT(Json Web Token)란?](https://mangkyu.tistory.com/56)